@* Views/Section/Edit.cshtml *@
@model StudentManagementSystem.Models.Section

@{
	ViewData["Title"] = "تعديل الشعبة";
	Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
<link href="~/css/field-styles.css" rel="stylesheet" />

<div class="container-fluid p-4">
	<div class="row justify-content-center">
		<div class="col-md-8 col-lg-6">
			<div class="card border-0 shadow-lg">
				<div class="card-header bg-primary text-white text-center py-4">
					<h3 class="mb-0 fw-bold">
						<i class="fas fa-edit me-2"></i>تعديل الشعبة
					</h3>
				</div>
				<div class="card-body p-5">
					<form asp-action="Edit" method="post" id="editSectionForm">
						<div asp-validation-summary="ModelOnly" class="text-danger mb-4"></div>

						<input asp-for="Id" type="hidden" />
						<input asp-for="CreatedBy_Id" type="hidden" />
						<input asp-for="Date" type="hidden" />

						<div class="mb-4">
							<label asp-for="Department_Id" class="form-label fw-bold text-primary">
								<i class="fas fa-building me-2"></i>القسم
							</label>
							<select asp-for="Department_Id" class="form-control form-control-lg" asp-items="ViewBag.Department_Id">
								<option value="">-- اختر القسم --</option>
							</select>
							<span asp-validation-for="Department_Id" class="text-danger"></span>
						</div>

						<div class="mb-4">
							<label asp-for="Name_Of_Section" class="form-label fw-bold text-primary">
								<i class="fas fa-sitemap me-2"></i>اسم الشعبة
							</label>
							<input asp-for="Name_Of_Section" id="sectionNameInput" class="form-control form-control-lg"
								   placeholder="أدخل اسم الشعبة" />
							<span asp-validation-for="Name_Of_Section" class="text-danger"></span>
							<div id="sectionNameError" class="text-danger mt-1" style="display:none;">
								<i class="fas fa-exclamation-circle me-1"></i>
								يجب أن يحتوي اسم الشعبة على أحرف، ولا يمكن أن يتكون من أرقام فقط.
							</div>
							<small id="charCounter" class="form-text text-muted"></small>
						</div>

						<div class="mb-4">
							<div class="card bg-light border-0">
								<div class="card-body p-3">
									<h6 class="card-title text-primary mb-3">
										<i class="fas fa-info-circle me-2"></i>معلومات الشعبة
									</h6>
									<div class="row">
										<div class="col-md-6 mb-2">
											<small class="text-muted">
												<i class="fas fa-user me-1"></i>
												أنشئت بواسطة: <strong>@(Model.CreatedBy?.Name ?? "غير محدد")</strong>
											</small>
										</div>
										<div class="col-md-6 mb-2">
											<small class="text-muted">
												<i class="fas fa-calendar me-1"></i>
												تاريخ الإنشاء: <strong>@Model.Date.ToString("dd/MM/yyyy")</strong>
											</small>
										</div>
										<div class="col-md-6">
											<small class="text-muted">
												<i class="fas fa-hashtag me-1"></i>
												رقم المعرف: <strong>@Model.Id</strong>
											</small>
										</div>
										<div class="col-md-6">
											<small class="text-muted">
												<i class="fas fa-building me-1"></i>
												القسم: <strong>@(Model.Department?.Name ?? "غير محدد")</strong>
											</small>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<button type="submit" class="btn btn-primary btn-lg w-100 mb-3" id="submitBtn">
									<i class="fas fa-save me-2"></i>حفظ التعديلات
								</button>
							</div>
							<div class="col-md-4">
								<a asp-controller="Department" asp-action="Details" asp-route-id="@Model.Department_Id" class="btn btn-secondary btn-lg w-100 mb-3" style="height: 48px; display: flex; align-items: center; justify-content: center;">
									<i class="fas fa-arrow-left me-2"></i>العودة للقسم
								</a>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}

	<script>
		$(document).ready(function () {
			const nameInput = $('#sectionNameInput');
			const nameError = $('#sectionNameError');
			const submitBtn = $('#submitBtn');

			// Function to validate that the name is not numbers-only
			function validateName(value) {
				const trimmedValue = value.trim();
				// Check if the value is empty or consists of only digits
				return trimmedValue !== '' && !/^\d+$/.test(trimmedValue);
			}

			// Function to update the validation state of the input field and error message
			function updateValidationState() {
				const isValid = validateName(nameInput.val());
				if (isValid) {
					nameError.hide();
					nameInput.removeClass('is-invalid');
				} else {
					nameError.show();
					nameInput.addClass('is-invalid');
				}
				// The existing ASP.NET validation span will also handle this via the form submit.
				// We keep this client-side for better user experience.
			}

			// Event listener for input: validates in real-time
			nameInput.on('input', updateValidationState);

			// Event listener for paste: validates after the paste action
			nameInput.on('paste', function(e) {
				// Wait for the paste event to complete before validating
				setTimeout(updateValidationState, 0);
			});

			// Form submission logic
			$('#editSectionForm').on('submit', function (e) {
				const departmentId = $('#Department_Id').val();
				const sectionName = nameInput.val();

				// Final validation checks
				let isFormValid = true;

				if (!departmentId) {
					isFormValid = false;
					$('#Department_Id').addClass('is-invalid');
				} else {
					$('#Department_Id').removeClass('is-invalid');
				}

				if (!validateName(sectionName)) {
					isFormValid = false;
					nameInput.addClass('is-invalid');
					nameError.show();
					alert('الرجاء إدخال اسم شعبة صحيح. يجب أن يحتوي على أحرف وليس أرقاماً فقط.');
				} else {
					nameInput.removeClass('is-invalid');
					nameError.hide();
				}

				if (!isFormValid) {
					e.preventDefault();
					nameInput.focus();
					return false;
				}

				// Show loading state and disable button if valid
				submitBtn.prop('disabled', true);
				submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...');
			});

			// Remove validation classes on input change
			$('#Department_Id').on('change', function () {
				$(this).removeClass('is-invalid');
			});
			// Remove validation class when user starts typing
			nameInput.on('keydown', function() {
				$(this).removeClass('is-invalid');
			});

			// Initialize character counter on page load
			const maxLength = 100;
			nameInput.on('input', function () {
				const currentLength = $(this).val().length;
				const remaining = maxLength - currentLength;
				$('#charCounter').text('عدد الأحرف المتبقية: ' + remaining);

				if (remaining < 10) {
					$('#charCounter').removeClass('text-muted').addClass('text-warning');
				} else {
					$('#charCounter').removeClass('text-warning').addClass('text-muted');
				}
			}).trigger('input'); // Trigger on load to set initial state

			// Auto-focus on section name input
			nameInput.focus();

			// Highlight changes with modern styling
			const originalValues = {
				department: $('#Department_Id').val(),
				name: nameInput.val()
			};

			$('#Department_Id, #sectionNameInput').on('change', function () {
				const fieldName = $(this).attr('id');
				const currentValue = $(this).val();
				let originalValue;

				if (fieldName === 'Department_Id') {
					originalValue = originalValues.department;
				} else if (fieldName === 'sectionNameInput') {
					originalValue = originalValues.name;
				}

				if (currentValue !== originalValue) {
					$(this).addClass('border-warning');
				} else {
					$(this).removeClass('border-warning');
				}
			});
		});
	</script>
}