@model List<StudentManagementSystem.Models.Student>
@{
    ViewData["Title"] = "عرض الغياب";
    var classId = ViewBag.ClassId;
    var selectedDate = ViewBag.SelectedDate;
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">عرض الغياب</h1>
        <a href="@Url.Action("Index")" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> رجوع
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">فلترة الغياب</h6>
        </div>
        <div class="card-body">
            <form method="get" action="@Url.Action("ViewAttendance", new { classId = classId })">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="date">التاريخ</label>
                        <input type="date" class="form-control" id="date" name="date"
                               value="@selectedDate.ToString("yyyy-MM-dd")" max="@DateTime.Today.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="form-group col-md-4 align-self-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> تطبيق الفلتر
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">سجل الغياب ليوم @selectedDate.ToString("yyyy/MM/dd")</h6>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="attendanceTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="regular-tab" data-toggle="tab" href="#regular" role="tab"
                       aria-controls="regular" aria-selected="true">الغياب العادي</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="field-tab" data-toggle="tab" href="#field" role="tab"
                       aria-controls="field" aria-selected="false">الغياب الميداني</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="exit-tab" data-toggle="tab" href="#exit" role="tab"
                       aria-controls="exit" aria-selected="false">إذن الخروج</a>
                </li>
            </ul>
            <div class="tab-content" id="attendanceTabsContent">
                <div class="tab-pane fade show active" id="regular" role="tabpanel" aria-labelledby="regular-tab">
                    <!-- Regular attendance content will be loaded via AJAX -->
                    <div class="text-center py-4" id="regularLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">جاري التحميل...</span>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="field" role="tabpanel" aria-labelledby="field-tab">
                    <!-- Field attendance content will be loaded via AJAX -->
                    <div class="text-center py-4" id="fieldLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">جاري التحميل...</span>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="exit" role="tabpanel" aria-labelledby="exit-tab">
                    <!-- Exit requests content will be loaded via AJAX -->
                    <div class="text-center py-4" id="exitLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">جاري التحميل...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Load initial data
            loadRegularAttendance();

            // Handle tab changes
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("href");

                if (target === "#regular" && !$('#regular').hasClass('loaded')) {
                    loadRegularAttendance();
                } else if (target === "#field" && !$('#field').hasClass('loaded')) {
                    loadFieldAttendance();
                } else if (target === "#exit" && !$('#exit').hasClass('loaded')) {
                    loadExitRequests();
                }
            });

            function loadRegularAttendance() {
                $.get('@Url.Action("GetRegularAttendanceData", new { classId = classId })',
                    { date: '@selectedDate.ToString("yyyy-MM-dd")' },
                    function(data) {
                        $('#regular').html(data);
                        $('#regular').addClass('loaded');
                    });
            }

            function loadFieldAttendance() {
                $.get('@Url.Action("GetFieldAttendanceData", new { classId = classId })',
                    { date: '@selectedDate.ToString("yyyy-MM-dd")' },
                    function(data) {
                        $('#field').html(data);
                        $('#field').addClass('loaded');
                    });
            }

            function loadExitRequests() {
                $.get('@Url.Action("GetExitRequestsData", new { classId = classId })',
                    { date: '@selectedDate.ToString("yyyy-MM-dd")' },
                    function(data) {
                        $('#exit').html(data);
                        $('#exit').addClass('loaded');
                    });
            }
        });
    </script>
}