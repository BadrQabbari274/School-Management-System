@model StudentManagementSystem.ViewModels.EvaluationMatrixViewModel
@{
    ViewData["Title"] = "تقييم الطلاب - " + Model.ClassName;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تقييم الطلاب - @Model.ClassName</h3>
                    <div class="card-tools">
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="fas fa-arrow-right"></i> رجوع
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    @if (Model.StudentEvaluationRows.Any() && Model.PracticalEvidences.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 200px;">اسم الطالب</th>
                                        <th style="width: 120px;">الرقم القومي</th>
                                        @foreach (var evidence in Model.PracticalEvidences)
                                        {
                                            <th class="text-center" style="min-width: 150px;">
                                                @evidence.Name
                                                <br>
                                                <small class="text-muted">(رقم: @evidence.Number)</small>
                                            </th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var studentRow in Model.StudentEvaluationRows)
                                    {
                                        <tr>
                                            <td class="font-weight-bold">@studentRow.Student.Name</td>
                                            <td class="text-center">
                                                @studentRow.Student.Natrual_Id
                                                <br>
                                                <small class="text-muted">
                                                    @if (studentRow.Student.Natrual_Id.Length == 14)
                                                    {
                                                        var genderDigit = studentRow.Student.Natrual_Id.Substring(12, 1);
                                                        if (genderDigit == "1" || genderDigit == "3")
                                                        {
                                                            <span class="badge badge-primary">ذكر</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge badge-pink">أنثى</span>
                                                        }
                                                    }
                                                </small>
                                            </td>
                                            @foreach (var evidenceStatus in studentRow.EvidenceStatuses)
                                            {
                                                <td class="text-center">
                                                    @if (evidenceStatus.IsEvaluated)
                                                    {
                                                        <span class="badge badge-success px-3 py-2">
                                                            <i class="fas fa-check"></i> تم التقييم
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <a href="@Url.Action("EvaluateStudent", new { 
                                                               studentId = evidenceStatus.StudentId, 
                                                               evidenceId = evidenceStatus.EvidenceId, 
                                                               tryId = evidenceStatus.TryId,
                                                               classId = Model.ClassId,
                                                               competencyId = Model.CompetencyId
                                                           })" 
                                                           class="btn btn-primary btn-sm">
                                                            <i class="fas fa-plus"></i> تقييم
                                                        </a>
                                                    }
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Statistics Summary -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">إحصائيات التقييم</h5>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="info-box bg-info">
                                                    <span class="info-box-icon"><i class="fas fa-users"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">إجمالي الطلاب</span>
                                                        <span class="info-box-number">@Model.StudentEvaluationRows.Count</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="info-box bg-success">
                                                    <span class="info-box-icon"><i class="fas fa-clipboard-list"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">الأدلة العملية</span>
                                                        <span class="info-box-number">@Model.PracticalEvidences.Count</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="info-box bg-warning">
                                                    <span class="info-box-icon"><i class="fas fa-male"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">الطلاب الذكور</span>
                                                        <span class="info-box-number">
                                                            @Model.StudentEvaluationRows.Count(s => 
                                                                s.Student.Natrual_Id.Length == 14 && 
                                                                (s.Student.Natrual_Id.Substring(12, 1) == "1" || s.Student.Natrual_Id.Substring(12, 1) == "3"))
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="info-box bg-danger">
                                                    <span class="info-box-icon"><i class="fas fa-female"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">الطالبات</span>
                                                        <span class="info-box-number">
                                                            @Model.StudentEvaluationRows.Count(s => 
                                                                s.Student.Natrual_Id.Length == 14 && 
                                                                (s.Student.Natrual_Id.Substring(12, 1) == "2" || s.Student.Natrual_Id.Substring(12, 1) == "4"))
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle"></i>
                            لا توجد بيانات طلاب أو أدلة عملية للعرض
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .badge-pink {
        background-color: #e91e63;
        color: white;
    }
    
    .table th {
        vertical-align: middle;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .info-box {
        border-radius: 8px;
    }
    
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>