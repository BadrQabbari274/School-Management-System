@model StudentManagementSystem.ViewModels.AbsentStudentsListViewModel
@{
    ViewData["Title"] = "الطلاب الغائبون اليوم";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body {
        direction: rtl;
        font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f7f8fa;
        min-height: 100vh;
        overflow-x: hidden;
    }

    .page-wrapper {
        background: #fff;
        min-height: 100vh;
        position: relative;
        box-shadow: 0 0 40px 0 rgba(0,0,0,0.04);
    }

    .container-fluid {
        position: relative;
        z-index: 1;
        padding: 2rem 1rem;
        max-width: 1200px;
        margin: auto;
    }

    /* Header */
    .page-header {
        background: #fff;
        border-radius: 18px;
        padding: 2rem 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 16px rgba(0,0,0,0.07);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        border: 1px solid #f0f0f0;
    }

    .page-title {
        color: #222;
        font-size: 2.3rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        letter-spacing: -1px;
    }

    .page-subtitle {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 0;
        font-weight: 500;
    }

    .back-btn {
        background: linear-gradient(90deg, #ff6b6b 0%, #ee5a52 100%);
        border: none;
        color: #fff;
        padding: 12px 32px;
        border-radius: 40px;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.13);
        outline: none;
        text-decoration: none;
        display: inline-block;
    }

    .back-btn:hover {
        background: linear-gradient(90deg, #ee5a52 0%, #ff6b6b 100%);
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.18);
        color: #fff;
        transform: translateY(-2px) scale(1.04);
        text-decoration: none;
    }

    /* Summary Card */
    .summary-card {
        background: #fff;
        border-radius: 16px;
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 16px rgba(0,0,0,0.07);
        border: 1px solid #f0f0f0;
        text-align: center;
    }

    .summary-number {
        font-size: 3rem;
        font-weight: 900;
        color: #ff6b6b;
        margin-bottom: 0.5rem;
        line-height: 1;
        letter-spacing: -1px;
    }

    .summary-label {
        color: #888;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .summary-date {
        color: #666;
        font-size: 1rem;
        font-weight: 500;
    }

    /* Students List */
    .students-container {
        background: #fff;
        border-radius: 16px;
        padding: 2rem 1.5rem;
        box-shadow: 0 2px 16px rgba(0,0,0,0.07);
        border: 1px solid #f0f0f0;
    }

    .students-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: #222;
        margin-bottom: 1.5rem;
        text-align: center;
        position: relative;
        letter-spacing: -1px;
    }

    .students-title::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, #ff6b6b 0%, #ee5a52 100%);
        border-radius: 2px;
    }

    .student-card {
        background: #f7f8fa;
        border-radius: 14px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
    }

    .student-card:hover {
        box-shadow: 0 8px 32px rgba(255, 107, 107, 0.13);
        transform: translateY(-2px);
        border-color: #ff6b6b;
    }

    .student-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        gap: 1rem;
    }

    .student-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #ff6b6b;
        background: #fff;
    }

    .student-info {
        flex: 1;
    }

    .student-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: #222;
        margin-bottom: 0.3rem;
    }

    .student-code {
        color: #666;
        font-size: 1rem;
        font-weight: 500;
    }

    .student-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detail-icon {
        width: 20px;
        color: #ff6b6b;
        font-size: 1rem;
    }

    .detail-label {
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
        min-width: 80px;
    }

    .detail-value {
        color: #222;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .absence-reason {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .reason-title {
        color: #856404;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .reason-text {
        color: #856404;
        font-size: 0.9rem;
    }

    .no-absences {
        text-align: center;
        padding: 3rem 1rem;
        color: #666;
    }

    .no-absences-icon {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 1rem;
    }

    .no-absences-text {
        font-size: 1.2rem;
        font-weight: 500;
    }

    /* Search Section */
    .search-section {
        background: #f0f0f0;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 16px rgba(0,0,0,0.07);
        border: 1px solid #e0e0e0;
    }

    .search-container {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-input {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        border-color: #ff6b6b;
        box-shadow: 0 0 10px rgba(255, 107, 107, 0.2);
        outline: none;
    }

    .search-icon {
        position: absolute;
        left: 15px;
        color: #888;
        font-size: 1.1rem;
    }

    .clear-search {
        position: absolute;
        right: 10px;
        background: none;
        border: none;
        color: #888;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .clear-search:hover {
        color: #ff6b6b;
        background: #f0f0f0;
    }

    .search-results-info {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #666;
    }

    /* Filter Section */
    .filter-section {
        background: #f0f0f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 16px rgba(0,0,0,0.07);
        border: 1px solid #e0e0e0;
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .filter-select {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        background-color: #fff;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-select:focus {
        border-color: #ff6b6b;
        box-shadow: 0 0 10px rgba(255, 107, 107, 0.2);
        outline: none;
    }

    .filter-actions {
        text-align: right;
    }

    .filter-status {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #666;
    }

    /* Hide students that don't match search/filters */
    .student-item.hidden-item {
        display: none !important;
    }

    /* Search highlight styling */
    .search-highlight {
        background-color: #fff3cd;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    /* No search results styling */
    .no-search-results {
        text-align: center;
        padding: 50px;
        color: #666;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none;
    }

    .no-search-results i {
        color: #ff6b6b;
        margin-bottom: 20px;
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .page-header { 
            flex-direction: column; 
            align-items: flex-start; 
            padding: 1.5rem; 
        }
        .page-title { font-size: 1.8rem; }
        .student-details { grid-template-columns: 1fr; }
        .student-header { flex-direction: column; text-align: center; }
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<div class="page-wrapper">
    <div class="container-fluid">
        <!-- Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">الطلاب الغائبون اليوم</h1>
                <p class="page-subtitle">تفاصيل الطلاب الغائبين بتاريخ @Model.AbsenceDate.ToString("dd/MM/yyyy")</p>
            </div>
            <a href="@Url.Action("Index", "Dashboard")" class="back-btn">
                <i class="fas fa-arrow-right me-2"></i>
                العودة للوحة التحكم
            </a>
        </div>

        <!-- Summary Card -->
        <div class="summary-card">
            <div class="summary-number">@Model.TotalAbsentCount</div>
            <div class="summary-label">إجمالي الطلاب الغائبين</div>
            <div class="summary-date">@Model.AbsenceDate.ToString("dddd dd MMMM yyyy", new System.Globalization.CultureInfo("ar-EG"))</div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="ابحث عن الطلاب (الاسم، الكود، الصف، الشعبة، القسم...)">
                <i class="fas fa-search search-icon"></i>
                <button type="button" class="clear-search" id="clearSearch">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-results-info" id="searchResults"></div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="gradeFilter" class="filter-label">
                            <i class="fas fa-graduation-cap me-2"></i>المرحلة الدراسية
                        </label>
                        <select id="gradeFilter" class="form-select filter-select">
                            <option value="">اختر المرحلة الدراسية</option>
                        </select>
                        <small class="form-text text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i>
                            اختر المرحلة الدراسية لتصفية الطلاب
                        </small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="classFilter" class="filter-label">
                            <i class="fas fa-chalkboard me-2"></i>الفصل
                        </label>
                        <select id="classFilter" class="form-select filter-select" disabled>
                            <option value="">اختر الفصل</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="filter-actions mt-3">
                <button type="button" id="clearFilters" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-times me-2"></i>مسح الفلاتر
                </button>
            </div>
            <div class="filter-status mt-2" id="filterStatus" style="display: none;">
                <small class="text-muted">
                    <i class="fas fa-filter me-1"></i>
                    <span id="filterStatusText"></span>
                </small>
            </div>
        </div>

        <!-- Students List -->
        <div class="students-container">
            <h3 class="students-title">تفاصيل الغياب (<span id="studentCount">@Model.TotalAbsentCount</span> طالب)</h3>
            
            @if (Model.AbsentStudents.Any())
            {
                @foreach (var student in Model.AbsentStudents)
                {
                    <div class="student-card student-item" 
                         data-name="@student.StudentName.ToLower()" 
                         data-code="@(student.StudentCode?.ToLower() ?? "")" 
                         data-class="@student.ClassName.ToLower()" 
                         data-section="@student.SectionName.ToLower()" 
                         data-department="@student.DepartmentName.ToLower()" 
                         data-grade="@student.GradeId.ToString()" 
                         data-class-id="@student.ClassId.ToString()">
                        <div class="student-header">
                            @if (!string.IsNullOrEmpty(student.StudentProfilePicture))
                            {
                                <img src="~/upload/@student.StudentId/@student.StudentProfilePicture" alt="صورة الطالب" class="student-avatar" />
                            }
                            else
                            {
                                <div class="student-avatar" style="background: #ff6b6b; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                    <i class="fas fa-user"></i>
                                </div>
                            }
                            <div class="student-info">
                                <div class="student-name">@student.StudentName</div>
                                <div class="student-code">@(string.IsNullOrEmpty(student.StudentCode) ? "لا يوجد كود" : student.StudentCode)</div>
                            </div>
                        </div>
                        
                        <div class="student-details">
                            <div class="detail-item">
                                <i class="fas fa-graduation-cap detail-icon"></i>
                                <span class="detail-label">الصف:</span>
                                <span class="detail-value">@student.ClassName</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-users detail-icon"></i>
                                <span class="detail-label">الشعبة:</span>
                                <span class="detail-value">@student.SectionName</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-building detail-icon"></i>
                                <span class="detail-label">القسم:</span>
                                <span class="detail-value">@student.DepartmentName</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-star detail-icon"></i>
                                <span class="detail-label">السنة:</span>
                                <span class="detail-value">@student.GradeName</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-clock detail-icon"></i>
                                <span class="detail-label">نوع الغياب:</span>
                                <span class="detail-value">@student.AttendanceTypeName</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(student.AbsenceReason) || !string.IsNullOrEmpty(student.CustomReasonDetails))
                        {
                            <div class="absence-reason">
                                <div class="reason-title">
                                    <i class="fas fa-info-circle me-2"></i>
                                    سبب الغياب:
                                </div>
                                <div class="reason-text">
                                    @if (!string.IsNullOrEmpty(student.AbsenceReason))
                                    {
                                        <strong>@student.AbsenceReason</strong>
                                    }
                                    @if (!string.IsNullOrEmpty(student.CustomReasonDetails))
                                    {
                                        @if (!string.IsNullOrEmpty(student.AbsenceReason))
                                        {
                                            <br />
                                        }
                                        @student.CustomReasonDetails
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="no-absences">
                    <div class="no-absences-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="no-absences-text">لا يوجد طلاب غائبين اليوم</div>
                </div>
            }
        </div>

        <!-- No Search Results -->
        <div id="noSearchResults" class="no-search-results">
            <i class="fas fa-search"></i>
            <div class="no-absences-text">لا توجد نتائج للبحث</div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger" style="margin-bottom: 1rem;">@ViewBag.ErrorMessage</div>
}

<script>
    // Filter variables
    let allStudents = [];
    let totalStudents = 0;
    let currentGradeFilter = '';
    let currentClassFilter = '';

    // Initialize search functionality
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const clearButton = document.getElementById('clearSearch');
        const searchResults = document.getElementById('searchResults');
        const noSearchResults = document.getElementById('noSearchResults');

        // Get all student items
        allStudents = Array.from(document.querySelectorAll('.student-item'));
        totalStudents = allStudents.length;

        // Initialize filters
        initializeFilters();

        // Update search results info on page load
        updateSearchResultsInfo('');
        
        // Update filter status
        updateFilterStatus();

        // Search input event listener
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            performSearch(searchTerm);

            // Show/hide clear button
            if (searchTerm) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }
        });

        // Clear search button
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            performSearch('');
            this.style.display = 'none';
            searchInput.focus();
        });

        // Clear search on Escape key
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                performSearch('');
                clearButton.style.display = 'none';
            }
        });

        // Filter event listeners
        const gradeFilter = document.getElementById('gradeFilter');
        const classFilter = document.getElementById('classFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');

        gradeFilter.addEventListener('change', function() {
            currentGradeFilter = this.value;
            handleGradeChange();
            updateFilterStatus();
        });

        classFilter.addEventListener('change', function() {
            currentClassFilter = this.value;
            applyFilters();
            updateFilterStatus();
        });

        clearFiltersBtn.addEventListener('click', function() {
            clearAllFilters();
        });
    });

    // Initialize filters by loading active grades
    async function initializeFilters() {
        try {
            const response = await fetch('/Dashboard/GetActiveGrades');
            if (response.ok) {
                const grades = await response.json();
                const gradeFilter = document.getElementById('gradeFilter');
                
                if (gradeFilter) {
                    // Clear existing options except the first one
                    gradeFilter.innerHTML = '<option value="">اختر المرحلة الدراسية</option>';
                    
                    // Add grade options
                    grades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade.value;
                        option.textContent = grade.text;
                        gradeFilter.appendChild(option);
                    });
                }
            } else {
                console.error('Failed to load grades:', response.status);
            }
        } catch (error) {
            console.error('Error loading grades:', error);
        }
    }

    // Handle grade selection change
    async function handleGradeChange() {
        const classFilter = document.getElementById('classFilter');
        
        if (!classFilter) return;
        
        if (currentGradeFilter) {
            try {
                const response = await fetch(`/Dashboard/GetClassesByGrade?gradeId=${currentGradeFilter}`);
                if (response.ok) {
                    const classes = await response.json();
                    
                    // Clear existing options except the first one
                    classFilter.innerHTML = '<option value="">اختر الفصل</option>';
                    
                    // Add class options
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.value;
                        option.textContent = cls.text;
                        classFilter.appendChild(option);
                    });
                    
                    // Enable class filter
                    classFilter.disabled = false;
                    currentClassFilter = '';
                } else {
                    console.error('Failed to load classes:', response.status);
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        } else {
            // Disable and clear class filter
            classFilter.disabled = true;
            classFilter.innerHTML = '<option value="">اختر الفصل</option>';
            currentClassFilter = '';
        }
        
        // Apply current filters
        applyFilters();
        
        // Update filter status
        updateFilterStatus();
    }

    // Perform search with filters
    function performSearch(searchTerm) {
        const searchResults = document.getElementById('searchResults');
        const noSearchResults = document.getElementById('noSearchResults');
        const studentsContainer = document.querySelector('.students-container');

        if (!searchTerm && !currentGradeFilter && !currentClassFilter) {
            // Show all rows if no search term and no filters
            allStudents.forEach(student => {
                student.classList.remove('hidden-item');
            });
            noSearchResults.style.display = 'none';
            if (studentsContainer) studentsContainer.style.display = '';
            updateSearchResultsInfo('');
            document.getElementById('studentCount').textContent = totalStudents;
            return;
        }

        const searchTermLower = searchTerm.toLowerCase();
        let visibleCount = 0;

        allStudents.forEach(student => {
            const name = student.dataset.name || '';
            const code = student.dataset.code || '';
            const className = student.dataset.class || '';
            const section = student.dataset.section || '';
            const department = student.dataset.department || '';
            const grade = student.dataset.grade || '';

            // Check if student matches search term
            const matchesSearch = !searchTerm || 
                name.includes(searchTermLower) ||
                code.includes(searchTermLower) ||
                className.includes(searchTermLower) ||
                section.includes(searchTermLower) ||
                department.includes(searchTermLower) ||
                grade.includes(searchTermLower);

            // Check if student matches current filters
            let matchesFilters = true;
            if (currentGradeFilter) {
                const studentGrade = student.dataset.grade;
                matchesFilters = matchesFilters && (studentGrade === currentGradeFilter);
            }
            if (currentClassFilter && matchesFilters) {
                const studentClassId = student.dataset.classId;
                matchesFilters = matchesFilters && (studentClassId === currentClassFilter);
            }

            // Student should be visible if it matches both search and filters
            if (matchesSearch && matchesFilters) {
                student.classList.remove('hidden-item');
                visibleCount++;
            } else {
                student.classList.add('hidden-item');
            }
        });

        // Update student count and show/hide no results
        const studentCount = document.getElementById('studentCount');
        const noResults = document.getElementById('noSearchResults');
        
        studentCount.textContent = visibleCount;
        
        if (visibleCount === 0) {
            noResults.style.display = 'block';
            if (studentsContainer) studentsContainer.style.display = 'none';
        } else {
            noResults.style.display = 'none';
            if (studentsContainer) studentsContainer.style.display = '';
        }

        // Update search results info
        updateSearchResultsInfo(searchTerm, visibleCount);
    }

    // Apply filters to student list
    function applyFilters() {
        // If there's a search term, use the search function which handles both search and filters
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput.value.trim();
        
        if (searchTerm) {
            performSearch(searchTerm);
        } else {
            let visibleCount = 0;
            
            allStudents.forEach(student => {
                let shouldShow = true;
                
                // Apply grade filter if selected
                if (currentGradeFilter) {
                    const studentGrade = student.dataset.grade;
                    if (studentGrade !== currentGradeFilter) {
                        shouldShow = false;
                    }
                }
                
                // Apply class filter if selected
                if (currentClassFilter && shouldShow) {
                    const studentClassId = student.dataset.classId;
                    if (studentClassId !== currentClassFilter) {
                        shouldShow = false;
                    }
                }
                
                if (shouldShow) {
                    student.classList.remove('hidden-item');
                    visibleCount++;
                } else {
                    student.classList.add('hidden-item');
                }
            });
            
            // Update student count and show/hide no results
            const studentCount = document.getElementById('studentCount');
            const studentsContainer = document.querySelector('.students-container');
            const noSearchResults = document.getElementById('noSearchResults');
            
            studentCount.textContent = visibleCount;
            
            if (visibleCount === 0) {
                noSearchResults.style.display = 'block';
                if (studentsContainer) studentsContainer.style.display = 'none';
            } else {
                noSearchResults.style.display = 'none';
                if (studentsContainer) studentsContainer.style.display = '';
            }
            
            // Update search results info
            updateSearchResultsInfo('', visibleCount);
            
            // Update filter status
            updateFilterStatus();
        }
    }

    // Clear all filters
    function clearAllFilters() {
        const gradeFilter = document.getElementById('gradeFilter');
        const classFilter = document.getElementById('classFilter');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearch');
        
        gradeFilter.value = '';
        classFilter.value = '';
        classFilter.disabled = true;
        classFilter.innerHTML = '<option value="">اختر الفصل</option>';
        
        // Clear search input
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        
        currentGradeFilter = '';
        currentClassFilter = '';
        
        // Show all students
        allStudents.forEach(student => {
            student.classList.remove('hidden-item');
        });
        
        // Update counts
        const studentCount = document.getElementById('studentCount');
        studentCount.textContent = totalStudents;
        
        // Show students container and hide no results
        const studentsContainer = document.querySelector('.students-container');
        const noSearchResults = document.getElementById('noSearchResults');
        if (studentsContainer) studentsContainer.style.display = '';
        noSearchResults.style.display = 'none';
        
        // Update search results info
        updateSearchResultsInfo('');
        
        // Update filter status
        updateFilterStatus();
    }

    // Update search results info
    function updateSearchResultsInfo(searchTerm, visibleCount = null) {
        const searchResults = document.getElementById('searchResults');
        
        if (searchTerm) {
            const count = visibleCount !== null ? visibleCount : allStudents.filter(s => !s.classList.contains('hidden-item')).length;
            searchResults.textContent = `تم العثور على ${count} نتيجة للبحث "${searchTerm}"`;
        } else if (currentGradeFilter || currentClassFilter) {
            const count = visibleCount !== null ? visibleCount : allStudents.filter(s => !s.classList.contains('hidden-item')).length;
            searchResults.textContent = `تم عرض ${count} طالب بعد تطبيق الفلاتر`;
        } else {
            searchResults.textContent = '';
        }
    }

    // Update filter status display
    function updateFilterStatus() {
        const filterStatus = document.getElementById('filterStatus');
        const filterStatusText = document.getElementById('filterStatusText');
        
        if (currentGradeFilter || currentClassFilter) {
            let statusText = '';
            if (currentGradeFilter && currentClassFilter) {
                const gradeText = document.getElementById('gradeFilter').options[document.getElementById('gradeFilter').selectedIndex].text;
                const classText = document.getElementById('classFilter').options[document.getElementById('classFilter').selectedIndex].text;
                statusText = `مفعل: ${gradeText} - ${classText}`;
            } else if (currentGradeFilter) {
                const gradeText = document.getElementById('gradeFilter').options[document.getElementById('gradeFilter').selectedIndex].text;
                statusText = `مفعل: ${gradeText}`;
            }
            
            filterStatusText.textContent = statusText;
            filterStatus.style.display = 'block';
        } else {
            filterStatus.style.display = 'none';
        }
    }

    // Add loading animations on page load
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.student-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
</script>
